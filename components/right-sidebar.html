{{define "right-sidebar"}}
<!-- Right Sidebar - Table of Contents -->
<aside :class="sidebarsOpen ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0'"
       class="hidden xl:block sticky top-16 h-[calc(100vh-4rem)] overflow-hidden transition-all duration-300 w-64 transform"
       x-data="{ 
           tocItems: {{toJSON .TOC}} || [],
           activeSection: '',
           currentScrollY: 0,
           showHeading: false,
           visibleItems: [],
           init() {
               // Ensure tocItems is always an array
               if (!Array.isArray(this.tocItems)) {
                   this.tocItems = [];
               }
               // Initialize scroll position
               this.currentScrollY = window.scrollY;
               // Set up intersection observer for active section tracking
               this.setupScrollTracking();
               // Set up scroll tracking for arrow directions
               this.setupScrollListener();
               // Start animations
               this.startAnimations();
           },
           startAnimations() {
               // Show heading first
               setTimeout(() => this.showHeading = true, 100);
               // Then stagger TOC items with overlapping animations
               this.tocItems.forEach((item, i) => {
                   setTimeout(() => this.visibleItems.push(i), 200 + (i * 50));
               });
           },
           setupScrollTracking() {
               if (!this.tocItems || this.tocItems.length === 0) return;
               
               const observer = new IntersectionObserver((entries) => {
                   entries.forEach(entry => {
                       if (entry.isIntersecting) {
                           this.activeSection = entry.target.id;
                       }
                   });
               }, {
                   rootMargin: '-20% 0% -35% 0%'
               });

               // Observe all heading elements
               this.tocItems.forEach(item => {
                   const element = document.getElementById(item.id);
                   if (element) {
                       observer.observe(element);
                   }
               });
           },
           setupScrollListener() {
               window.addEventListener('scroll', () => {
                   this.currentScrollY = window.scrollY;
               });
           },
           scrollToSection(anchor) {
               const element = document.getElementById(anchor);
               if (element) {
                   element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                   // Update URL with the anchor hash without triggering navigation
                   if (window.history && window.history.pushState) {
                       window.history.pushState(null, '', '#' + anchor);
                   }
               }
           },
           getArrowDirection(itemId) {
               const element = document.getElementById(itemId);
               if (!element) return '→';
               
               const elementTop = element.offsetTop;
               const viewportCenter = this.currentScrollY + (window.innerHeight / 2);
               
               return elementTop > viewportCenter ? '↓' : '↑';
           }
       }">
    <div class="pt-32 p-4 overflow-y-auto flex flex-col h-full">
        <div class="flex-1">
            <div x-show="tocItems && Array.isArray(tocItems) && tocItems.length > 0">
                <h3 x-show="showHeading" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" class="text-sm font-semibold text-gray-900 dark:text-gray-100 mb-4">{{t "common.on_this_page"}}</h3>
                <nav class="space-y-1" id="toc-nav">
                    <template x-for="(item, index) in tocItems" :key="item.id">
                        <a x-show="visibleItems.includes(index)" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" :href="'#' + item.id" @click.prevent="scrollToSection(item.id)" :class="activeSection === item.id ? 'text-brand-blue bg-blue-50 dark:bg-blue-950/30 font-medium' : 'text-gray-600 dark:text-gray-300 hover:text-brand-blue'" class="toc-link block text-sm px-2 py-1.5 rounded-md relative transition-colors duration-200">
                            <span x-text="item.title"></span>
                            <span class="toc-arrow transition-transform duration-200" x-text="getArrowDirection(item.id)"></span>
                        </a>
                    </template>
                </nav>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="flex justify-center mt-8">
            <a href="/platform/status" class="text-sm leading-6 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 flex items-center transition-colors duration-200">
                <span class="relative flex h-3 w-3 mr-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75" style="background-color: #00a0d2;"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3" style="background-color: #00a0d2;"></span>
                </span>
{{t "common.system_status"}}
            </a>
        </div>
    </div>
</aside>
{{end}}