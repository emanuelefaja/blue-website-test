{{define "language-switcher"}}
<div class="relative z-50" 
     x-data="{ 
        languageMenuOpen: false,
        currentLang: '{{.Language}}',
        languages: [
            { code: 'en', flag: 'us', name: 'English' },
            { code: 'zh', flag: 'cn', name: '简体中文' },
            { code: 'es', flag: 'es', name: 'Español' },
            { code: 'fr', flag: 'fr', name: 'Français' },
            { code: 'de', flag: 'de', name: 'Deutsch' },
            { code: 'ja', flag: 'jp', name: '日本語' },
            { code: 'pt', flag: 'pt', name: 'Português' },
            { code: 'ru', flag: 'ru', name: 'Русский' },
            { code: 'ko', flag: 'kr', name: '한국어' },
            { code: 'it', flag: 'it', name: 'Italiano' },
            { code: 'id', flag: 'id', name: 'Indonesian' },
            { code: 'nl', flag: 'nl', name: 'Nederlands' },
            { code: 'pl', flag: 'pl', name: 'Polski' },
            { code: 'zh-TW', flag: 'tw', name: '繁體中文' },
            { code: 'sv', flag: 'se', name: 'Svenska' },
            { code: 'km', flag: 'kh', name: 'ភាសាខ្មែរ' }
        ],
        selectedLanguage: null,
        hoverTimeout: null,
        init() {
            // Set selected language based on current language
            this.selectedLanguage = this.languages.find(lang => lang.code === this.currentLang) || this.languages[0];
        },
        openMenuOnHover() {
            clearTimeout(this.hoverTimeout);
            this.languageMenuOpen = true;
        },
        closeMenuWithDelay() {
            this.hoverTimeout = setTimeout(() => {
                this.languageMenuOpen = false;
            }, 300);
        },
        getCurrentPath() {
            // Get the current path from the browser's location
            const path = window.location.pathname;
            // Remove language prefix if present
            const langPattern = /^\/([a-z]{2}|[a-z]{2}-[A-Z]{2})(\/|$)/;
            const cleanPath = path.replace(langPattern, '/');
            return cleanPath === '' ? '/' : cleanPath;
        },
        switchLanguage(language) {
            if (language.code === this.currentLang) {
                // Already on this language
                this.languageMenuOpen = false;
                return;
            }
            
            // Handle font loading/unloading for language switch
            if (window.FontLoader && typeof window.FontLoader.handleLanguageSwitch === 'function') {
                window.FontLoader.handleLanguageSwitch(language.code);
            }
            
            // Get the current path dynamically
            const currentPath = this.getCurrentPath();
            
            // Build the new URL with the language prefix
            let newPath;
            if (currentPath === '/') {
                newPath = '/' + language.code;
            } else {
                newPath = '/' + language.code + currentPath;
            }
            
            // Set cookie for persistence
            document.cookie = 'lang=' + language.code + '; path=/; max-age=' + (365 * 24 * 60 * 60);
            
            // Use SPA navigation to avoid page reload and flashing
            if (window.SPAUtils && window.SPAUtils.handleNavigation) {
                // Close the language menu first
                this.languageMenuOpen = false;
                
                // Create a temporary anchor element to trigger SPA navigation
                const tempLink = document.createElement('a');
                tempLink.href = newPath;
                
                // Use the SPA navigation system with language switch flag
                window.SPAUtils.handleNavigation(tempLink, true);
            } else {
                // Fallback to full reload if SPA not available
                window.location.href = newPath;
            }
        }
     }" 
     @mouseenter="openMenuOnHover()"
     @mouseleave="closeMenuWithDelay()">
    
    <button class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 focus:outline-none transition-colors duration-200 cursor-pointer"
            :aria-label="'Language: ' + selectedLanguage.name"
            aria-haspopup="true"
            :aria-expanded="languageMenuOpen">
        <!-- Globe icon -->
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
        </svg>
    </button>
    
    <!-- Language Dropdown -->
    <div x-show="languageMenuOpen"
         @mouseenter="openMenuOnHover()"
         @mouseleave="closeMenuWithDelay()"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 translate-y-1"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-1"
         class="absolute right-0 top-full mt-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50 min-w-[400px]">
        <div class="grid grid-cols-2">
            <template x-for="(language, index) in languages" :key="language.code">
                <div @click="switchLanguage(language)"
                     class="px-4 py-2.5 cursor-pointer transition-colors"
                     :class="selectedLanguage.code === language.code ? 'bg-blue-50 dark:bg-blue-900/30' : 'hover:bg-blue-50 dark:hover:bg-blue-900/30'">
                    <div class="flex items-center gap-2 min-w-0">
                        <img :src="'/flags/' + language.flag + '.svg'" 
                             :alt="language.name + ' flag'"
                             class="flex-shrink-0 w-5 h-4 rounded-sm object-cover shadow-sm">
                        <span class="text-sm text-gray-900 dark:text-gray-100 whitespace-nowrap" 
                              :class="selectedLanguage.code === language.code ? 'font-bold' : 'font-medium'"
                              x-text="language.name"></span>
                        <svg x-show="selectedLanguage.code === language.code" 
                             class="ml-auto w-4 h-4 text-brand-blue flex-shrink-0" 
                             fill="currentColor" 
                             viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{{end}}